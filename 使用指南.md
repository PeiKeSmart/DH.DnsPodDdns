# DH.DnsPodDdns 使用指南

## 快速开始

### 1. 获取 DNSPod Token

1. 登录 [DNSPod 控制台](https://console.dnspod.cn/)
2. 进入"用户中心" -> "安全设置" -> "API Token"
3. 创建新的 Token，格式为：`ID,Token`
4. 例如：`12345,abcdef123456789`

### 2. 基本使用

```csharp
using DH.DnsPodDdns;
using DH.DnsPodDdns.Models;
using DH.DnsPodDdns.Services;
using NewLife.Log;

// 配置日志（可选）
XTrace.UseConsole();

// 基本 API 调用
using var dnspod = new Dnspod();

// 获取域名记录
var records = await dnspod.RecordListAsync("your_token", "example.com");
if (records?.records != null)
{
    foreach (var record in records.records)
    {
        Console.WriteLine($"{record.name}.{records.domain.name} -> {record.value} ({record.type})");
    }
}

// 更新 DNS 记录
var result = await dnspod.DdnsAsync(
    "your_token",       // DNSPod Token  
    "example.com",      // 域名
    "record_id",        // 记录ID
    "home",             // 子域名
    "默认",             // 线路
    "1.2.3.4"          // 新IP
);
```

### 3. 获取公网IP

```csharp
using var ipService = new IpAddressService();
var currentIp = await ipService.GetPublicIpAsync();
Console.WriteLine($"当前公网IP: {currentIp}");
```

### 4. 完整的 DDNS 服务

```csharp
// 配置 DDNS 参数
var config = new DdnsConfig
{
    Token = "your_dnspod_token",        // 替换为你的 Token
    Domain = "example.com",             // 你的域名
    SubDomain = "home",                 // 子域名
    RecordLine = "默认",                // 解析线路
    Ttl = 600,                          // TTL值（秒）
    UpdateInterval = 5,                 // 自动更新间隔（分钟）
    EnableAutoUpdate = false            // 是否启用自动更新
};

// 创建 DDNS 服务
using var ddnsService = new DdnsService(config);

// 执行一次更新
var updateResult = await ddnsService.UpdateAsync();
if (updateResult.Success)
{
    Console.WriteLine($"更新成功: {updateResult.Message}");
    if (updateResult.Changed)
    {
        Console.WriteLine($"IP已从 {updateResult.OldIpAddress} 更新为 {updateResult.IpAddress}");
    }
}
else
{
    Console.WriteLine($"更新失败: {updateResult.Message}");
}

// 查看当前 DNS 记录
var record = await ddnsService.GetDnsRecordAsync();
if (record != null)
{
    Console.WriteLine($"当前记录: {record.name}.{config.Domain} -> {record.value}");
}
```

### 5. 启用自动更新

```csharp
var config = new DdnsConfig
{
    Token = "your_dnspod_token",
    Domain = "example.com", 
    SubDomain = "home",
    UpdateInterval = 5,                 // 每5分钟检查一次
    EnableAutoUpdate = true             // 启用自动更新
};

using var ddnsService = new DdnsService(config);

Console.WriteLine("DDNS自动更新已启动，按任意键停止...");
Console.ReadKey();

// 服务会在 using 块结束时自动停止
```

## API 参考

### Dnspod 类

**主要方法：**

- `RecordListAsync(token, domain)` - 获取域名记录列表
- `DdnsAsync(token, domain, recordId, subDomain, recordLine, value)` - 更新DNS记录

### IpAddressService 类

**主要方法：**

- `GetPublicIpAsync()` - 获取当前公网IP

### DdnsService 类

**主要方法：**

- `UpdateAsync()` - 执行DDNS更新
- `GetDnsRecordAsync()` - 获取DNS记录信息
- `StartAutoUpdate()` - 启动自动更新
- `StopAutoUpdate()` - 停止自动更新

### DdnsConfig 配置

**必填参数：**
- `Token` - DNSPod API Token（格式：ID,Token）
- `Domain` - 主域名
- `SubDomain` - 子域名

**可选参数：**
- `RecordLine` - 解析线路（默认："默认"）
- `Ttl` - TTL值（默认：600秒）
- `UpdateInterval` - 自动更新间隔（默认：5分钟）
- `EnableAutoUpdate` - 是否启用自动更新（默认：false）

## 解析线路选项

- `默认` - 默认线路
- `电信` - 电信线路  
- `联通` - 联通线路
- `移动` - 移动线路
- `教育网` - 教育网线路
- `境外` - 境外线路

## 错误处理

```csharp
try
{
    var result = await ddnsService.UpdateAsync();
    // 处理结果
}
catch (InvalidOperationException ex)
{
    // DNSPod API错误
    Console.WriteLine($"API错误: {ex.Message}");
}
catch (ArgumentException ex)
{
    // 配置错误
    Console.WriteLine($"配置错误: {ex.Message}");
}
catch (Exception ex)
{
    // 其他错误
    Console.WriteLine($"未知错误: {ex.Message}");
}
```

## 注意事项

1. **Token 格式**：必须是 `ID,Token` 格式，例如 `12345,abcdef123456789`
2. **DNS 记录**：确保在 DNSPod 控制台已创建对应的 A 记录
3. **网络连接**：确保网络能正常访问 DNSPod API 和 IP 获取服务
4. **日志记录**：使用 XTrace 进行日志记录，可以通过 `XTrace.UseConsole()` 查看详细信息

## 常见问题

**Q: 如何获取记录ID？**
A: 使用 `RecordListAsync` 方法获取域名所有记录，从中找到对应记录的 ID。

**Q: 支持哪些记录类型？**
A: 目前主要支持 A 记录，用于IPv4地址的DDNS更新。

**Q: 更新频率建议？**
A: 建议不要低于5分钟，避免频繁调用API。

**Q: IP获取失败怎么办？**
A: 库会自动尝试多个IP获取服务，如果都失败请检查网络连接。
